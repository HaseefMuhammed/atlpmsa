<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ATL PMSA</title>
  <link rel="icon" href="images/tab.png" type="image/logo">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="bootstrap.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
  <nav class="navbar navbar-expand-lg bg-body-tertiary fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html"><b class="brand">ATL PMSA</b></a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mb-2 mb-lg-0 ms-auto mx-5">
          <li class="nav-item">
            <a class="nav-link active text-danger" aria-current="page" href="index.html">STUDENTS PORTAL</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="login.html">ADMIN</a>
          </li>
  </nav>

    <!-- Preloader -->
    <div id="preloader">
    </div>

    
  <div class="p-5"></div>

  <!-- NAV -->

  <section>
    <div class="ttl">FIND IT</div>

    <section class="text-center swithcode mt-3">
      <div class="d-flex justify-content-center align-items-center">
        <div class="position-relative">
            <input id="searchInput" type="text"
                   class="form-control rounded-pill search-bar pe-5"
                   placeholder="Search..."
                   aria-label="Search">
            <button class="btn position-absolute top-50 end-0 translate-middle-y" type="button" id="searchBtn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                    <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                </svg>
            </button>
        </div>
      </div>
    </section>

        <!-- Popup Modal -->
<div id="loadingPopup" class="popup" style="display: none;">
  <div class="popup-content">
    <p>Submitting your data...</p>
  </div>
</div>

    <br>
    <form id="findForm" method="">
      <div class="container">
        <div class="form-row row">
          <div class="form-group col-md-6">
            <label for="inputEmail4">Enter roll number</label><i class="text-danger">*</i>
            <input
              type="number"
              class="form-control"
              id="rollNo"
              name="Roll No"
              placeholder="000"
              required
            />
          </div>
          <div class="form-group col-md-6">
            <label for="inputPassword4">Name</label>
            <input
              type="text"
              class="form-control"
              name="Student Name"
              id="studentName"
              placeholder="Your name will display here !!"
              readonly
            />
          </div>
        </div>
        <div class="mt-3"></div>
        <div class="form-group">
          <div class="row">
            <div class="form-group col-md-4">
              <label for="item1">Select item</label><i class="text-danger">*</i>
              <select id="item1" name="Item1" class="form-control" required>
                <option selected value="">Choose...</option>
              </select>
            </div>
            <div class="form-group col-md-4">
              <label for="item2">Select item</label>
              <select id="item2" name="Item2" class="form-control" >
                <option selected value="">Choose...</option>
              </select>
            </div>
            <div class="form-group col-md-4">
              <label for="item3">Select item</label>
              <select id="item3" name="Item3" class="form-control" >
                <option selected value="">Choose...</option>
              </select>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-md-4">
              <label for="qty1">Select QTY</label><i class="text-danger">*</i>
              <select id="qty1" name="QTY 1" class="form-control" required>
                <option selected value="">Choose...</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="qty2">Select QTY</label>
              <select id="qty2" name="QTY 2" class="form-control" >
                <option selected value="">Choose...</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="qty3">Select QTY</label>
              <select id="qty3" name="QTY 3" class="form-control" >
                <option selected value="">Choose...</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
              </select>
            </div>
          </div>
        </div>
        <input type="time" id="timeInput" class="mt-3" name="Time" readonly>
        
        <section class="status mt-3">
          <label for="">Status</label><i class="text-danger">*</i>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="Status" value="Take it" id="flexRadioDefault1" checked>
            <label class="form-check-label" for="flexRadioDefault1">
              Take it
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="Status" value="Place it back" id="flexRadioDefault2" >
            <label class="form-check-label" for="flexRadioDefault2">
              Place it back
            </label>
          </div>
        </section>
        <button
          type="submit"
          class="btn btn-dark mt-3 sub-btn"
          style="display: block;"
        >
          Submit
        </button>
      </div>
    </form>
  </section>
  <footer class="bg-dark mt-3">
    <p>&copy <i id="year"></i> ATL@PMSA <br>Managed by TEB INNOVATIONS <br> Developed by <a href="https://haseef-ws.netlify.app" target="_blank">Haseef Muhammed PC</a> & <a href="https://tebinnovations.in" target="_blank">TEB Innovations</a> </p>
  </footer>
  

  <script src="bootstrap.js"></script>
  <script src="script.js"></script>
  <script src="studentsDataBase.js"></script>
  <script src="main.js"></script>
  <script>
// --- Dynamic Item Dropdowns from Google Sheet CSV ---
let itemData = [];
let itemMap = {};
let csvLoaded = false;

fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vRf_j-7zlSjWD70FDkgu1kNhss79FTO9HvLnNrfBRmgDAIfv0BC_mJ0mO8V4Nkz_UxLti6QQc0gAAT1/pub?output=csv')
  .then(response => response.text())
  .then(csv => {
    const lines = csv.split('\n');
    const headers = lines[0].split(',');
    const itemIdx = headers.findIndex(h => h.trim().toLowerCase() === 'item');
    const locationIdx = headers.findIndex(h => h.trim().toLowerCase().startsWith('location'));
    for (let i = 1; i < lines.length; i++) {
      const row = lines[i].split(',');
      if (row.length > Math.max(itemIdx, locationIdx)) {
        const item = row[itemIdx].trim();
        const location = row[locationIdx].trim();
        if (item) {
          itemData.push(item);
          itemMap[item] = location;
        }
      }
    }
    csvLoaded = true;
    // Populate select options dynamically
    ["#item1", "#item2", "#item3"].forEach(sel => {
      const $select = $(sel);
      if ($select.length) {
        $select.empty();
        $select.append('<option value="">Choose...</option>');
        itemData.forEach(item => {
          $select.append(`<option value="${item}">${item}</option>`);
        });
      }
    });
  });

$("#findForm").submit((e) => {
  e.preventDefault();
  $("#loadingPopup").show();
  if (!csvLoaded) {
    $("#loadingPopup").hide();
    $('#itemLocationModalBody').html('Item data is still loading. Please wait a moment and try again.');
    var modal = new bootstrap.Modal(document.getElementById('itemLocationModal'));
    modal.show();
    return;
  }
  const item1 = $("#item1").val();
  const item2 = $("#item2").val();
  const item3 = $("#item3").val();
  if (!item1) {
    $("#loadingPopup").hide();
    $('#itemLocationModalBody').html('Please select at least one item.');
    var modal = new bootstrap.Modal(document.getElementById('itemLocationModal'));
    modal.show();
    return;
  }
  const location1 = itemMap[item1] || "Unknown";
  const location2 = item2 ? (itemMap[item2] || "Unknown") : "";
  const location3 = item3 ? (itemMap[item3] || "Unknown") : "";
  $.ajax({
    url: "https://script.google.com/macros/s/AKfycbzHFd8NiDfzaI50NHXBsZypUtpAEgM5CZ1g67H0T0KDa-bEaiBEwpV9eJtJrye2nc2C/exec",
    data: $("#findForm").serialize(),
    method: "POST",
    success: function (response) {
      $("#loadingPopup").hide();
      let msg = `<b>Item Locations:</b><br><br>1. <b>${item1}</b>: ${location1}`;
      if (item2) msg += `<br>2. <b>${item2}</b>: ${location2}`;
      if (item3) msg += `<br>3. <b>${item3}</b>: ${location3}`;
      msg += "<br><br><i>After the usage, take it back to its place!</i>";
      $('#itemLocationModalBody').html(msg);
      var modal = new bootstrap.Modal(document.getElementById('itemLocationModal'));
      modal.show();
      $('#itemLocationModal').on('hidden.bs.modal', function () {
        window.location.reload();
      });
    },
    error: function (err) {
      $("#loadingPopup").hide();
      $('#itemLocationModalBody').html('Something went wrong while submitting the form.');
      var modal = new bootstrap.Modal(document.getElementById('itemLocationModal'));
      modal.show();
    }
  });
});

// --- Roll No to Name Autofill from Google Sheet CSV (for student name) ---
let rollToNameMap = {};
let studentCsvLoaded = false;

fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vTZOeapGelwIb3wK8it_zgdZagXnlEU8RYWxv3HtvLp-rYe4OmEwbxRs4_ieHTdjRzDLmzZFHOhmu1J/pub?output=csv')
  .then(response => response.text())
  .then(csv => {
    const lines = csv.split('\n');
    const headers = lines[0].split(',');
    const rollIdx = headers.findIndex(h => h.toLowerCase().includes('roll'));
    const nameIdx = headers.findIndex(h => h.toLowerCase().includes('name'));
    for (let i = 1; i < lines.length; i++) {
      const row = lines[i].split(',');
      if (row.length > Math.max(rollIdx, nameIdx)) {
        const rollKey = row[rollIdx].trim().replace(/^0+/, '');
        rollToNameMap[rollKey] = row[nameIdx].trim();
      }
    }
    studentCsvLoaded = true;
  });

$('#rollNo').on('input', function() {
  const rollRaw = $(this).val();
  if (!studentCsvLoaded) {
    $('#studentName').val('Loading...');
    return;
  }
  const roll = rollRaw.trim().replace(/^0+/, '');
  if (!roll) {
    $('#studentName').val('');
    return;
  }
  const name = rollToNameMap[roll] || '';
  $('#studentName').val(name ? name : 'Cant find student with this roll number');
});

// --- Item Code to Name Search (CSV) ---
let codeToItemMap = {};
let codeCsvLoaded = false;

fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vRf_j-7zlSjWD70FDkgu1kNhss79FTO9HvLnNrfBRmgDAIfv0BC_mJ0mO8V4Nkz_UxLti6QQc0gAAT1/pub?output=csv')
  .then(response => response.text())
  .then(csv => {
    const lines = csv.split('\n');
    const headers = lines[0].split(',');
    const codeIdx = headers.findIndex(h => h.trim().toLowerCase() === 'code');
    const itemIdx = headers.findIndex(h => h.trim().toLowerCase() === 'item');
    for (let i = 1; i < lines.length; i++) {
      const row = lines[i].split(',');
      if (row.length > Math.max(codeIdx, itemIdx)) {
        const code = row[codeIdx].trim();
        const item = row[itemIdx].trim();
        if (code && item) {
          codeToItemMap[code] = item;
        }
      }
    }
    codeCsvLoaded = true;
  });

$('#searchBtn').on('click', function() {
  const code = $('#searchInput').val().trim();
  if (!codeCsvLoaded) {
    $('#itemCodeModalBody').html('Loading item data...');
  } else if (!code) {
    $('#itemCodeModalBody').html('Please enter a code.');
  } else {
    const item = codeToItemMap[code];
    if (item) {
      $('#itemCodeModalBody').html(`<b>Item for code ${code}:</b><br>${item}`);
    } else {
      $('#itemCodeModalBody').html('No item found for this code.');
    }
  }
  var modal = new bootstrap.Modal(document.getElementById('itemCodeModal'));
  modal.show();
});

$('#searchInput').on('keypress', function(e) {
  if (e.which === 13) {
    $('#searchBtn').click();
    e.preventDefault();
  }
});
  </script>

  <!-- Item Code Search Result Modal -->
<div class="modal fade" id="itemCodeModal" tabindex="-1" aria-labelledby="itemCodeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="itemCodeModalLabel">Item Lookup</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center" id="itemCodeModalBody">
        <!-- Content set by JS -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>
<!-- Item Location Result Modal -->
<div class="modal fade" id="itemLocationModal" tabindex="-1" aria-labelledby="itemLocationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="itemLocationModalLabel">Item Locations</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center" id="itemLocationModalBody">
        <!-- Content set by JS -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>
</body>
</html>